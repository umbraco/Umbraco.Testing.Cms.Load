parameters:
  - name: hostName
    type: string
  - name: umbracoVersion
    type: string
  - name: appServiceName
    type: string
  - name: testName
    type: string
  - name: userAmount
    type: number

steps:
  - ${{ if and(parameters.umbracoVersion, ne(parameters.umbracoVersion, '')) }}:
      - script: echo ${{ parameters.umbracoVersion }}
        displayName: testVersion
      - task: AzureCLI@2
        name: startAppService${{ parameters.testName }}
        displayName: 'Start App Service for ${{ parameters.testName }}'
        inputs:
          azureSubscription: '$(serviceConnection)'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: az webapp start -n ${{ parameters.appServiceName }} -g $(azurergname)

      - task: PowerShell@2
        displayName: 'Sleep for Warm-up - ${{ parameters.testName }}'
        inputs:
          targetType: 'inline'
          script: Start-Sleep -Seconds 180

      - task: k6-load-test@0
        displayName: 'Run K6 Load Test'
        continueOnError: true
        inputs:
          args: '-e HOST_NAME=${{ parameters.hostName }} -e USERS=${{ parameters.userAmount }} -e K6_WEB_DASHBOARD=true -e K6_WEB_DASHBOARD_EXPORT=${{ parameters.umbracoVersion }}-dashboard.html -e K6_SUMMARY_EXPORT=${{ parameters.umbracoVersion }}-summary.html'
          fileName: '$(System.DefaultWorkingDirectory)/loadtests/K6LoadTest.js'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish K6 Dashboard HTML for ${{ parameters.umbracoVersion }}'
        continueOnError: true
        inputs:
          PathtoPublish: '$(System.DefaultWorkingDirectory)/${{ parameters.umbracoVersion }}-dashboard.html'
          ArtifactName: 'dashboard-for-${{ parameters.umbracoVersion }}'
          publishLocation: 'Container'

      - task: PublishBuildArtifacts@1
        displayName: 'Publish K6 Summary HTML for ${{ parameters.umbracoVersion }}'
        continueOnError: true
        inputs:
          PathtoPublish: '$(System.DefaultWorkingDirectory)/${{ parameters.umbracoVersion }}-summary.html'
          ArtifactName: 'summary-for-${{ parameters.umbracoVersion }}'
          publishLocation: 'Container'

      - task: PublishTestResults@2
        displayName: 'Publish K6 JUnit Results'
        continueOnError: true
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/k6-results.xml'
          testRunTitle: 'K6 Load Testing for ${{ parameters.umbracoVersion }}'
parameters:
  - name: hostName
    type: string
  - name: umbracoVersion
    type: string
  - name: appServiceName
    type: string
  - name: testName
    type: string
  - name: userAmount
    type: number

steps:
  - ${{ if ne(parameters.hostName, '') }}:
      - task: AzureCLI@2
        name: startAppService${{ parameters.testName }}
        displayName: 'Start App Service for ${{ parameters.testName }}'
        inputs:
          azureSubscription: '$(serviceConnection)'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: az webapp start -n ${{ parameters.appServiceName }} -g $(azurergname)

      - task: PowerShell@2
        displayName: 'Sleep for Warm-up - ${{ parameters.testName }}'
        inputs:
          targetType: 'inline'
          script: Start-Sleep -Seconds 180

      - script: |
          docker run --rm \
            -e HOST_NAME=${{ parameters.hostName }} \
            -e USERS=${{ parameters.userAmount }} \
            -v $(System.DefaultWorkingDirectory):/scripts \
            grafana/k6 run /scripts/$(loadTestFileLocation) \
            --summary-export=/scripts/results-${{ parameters.umbracoVersion }}.json
        displayName: 'Run k6 Load Test with Docker for ${{ parameters.testName }} (version ${{ parameters.umbracoVersion }})'

      - script: npm install -g k6-to-junit
        displayName: 'Install k6-to-junit CLI'

      - script: |
          k6-to-junit /scripts/results-${{ parameters.umbracoVersion }}.json > k6-results-${{ parameters.umbracoVersion }}.xml
        workingDirectory: $(System.DefaultWorkingDirectory)
        displayName: 'Convert k6 Results to JUnit (version ${{ parameters.umbracoVersion }})'

      - task: PublishTestResults@2
        displayName: 'Publish k6 Test Results (version ${{ parameters.umbracoVersion }})'
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/k6-results-${{ parameters.umbracoVersion }}.xml'
          failTaskOnFailedTests: true
          testRunTitle: 'k6 Load Test - ${{ parameters.testName }} (version ${{ parameters.umbracoVersion }})'
